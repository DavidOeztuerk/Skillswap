name: Deploy to Azure

on:
  push:
    branches: 
      - develop    # â†’ Dev Environment
      - staging    # â†’ Staging Environment
      - main       # â†’ Production Environment
  pull_request:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

env:
  # Dynamic environment based on branch
  ENVIRONMENT: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production') || (github.ref == 'refs/heads/staging' && 'staging') || (github.ref == 'refs/heads/develop' && 'dev') || 'dev' }}
  RESOURCE_GROUP: skillswap-rg  # Using existing resource group
  LOCATION: westeurope

jobs:
  # Phase 1: Deploy Infrastructure
  deploy-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      registry_name: ${{ steps.deploy.outputs.registry_name }}
      registry_login_server: ${{ steps.deploy.outputs.registry_login_server }}
      registry_username: ${{ steps.deploy.outputs.registry_username }}
      registry_password: ${{ steps.deploy.outputs.registry_password }}
      postgres_connection: ${{ steps.deploy.outputs.postgres_connection }}
      redis_connection: ${{ steps.deploy.outputs.redis_connection }}
      servicebus_connection: ${{ steps.deploy.outputs.servicebus_connection }}
      container_env_id: ${{ steps.deploy.outputs.container_env_id }}
      jwt_secret: ${{ steps.deploy.outputs.jwt_secret }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy Infrastructure
        id: deploy
        run: |
          # Generate secure passwords if not provided
          POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
          if [ -z "$POSTGRES_PASSWORD" ]; then
            POSTGRES_PASSWORD="SkillSwap2024SecurePassword!"
          fi
          
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          if [ -z "$JWT_SECRET" ]; then
            JWT_SECRET="your-super-secure-jwt-secret-key-that-is-at-least-32-characters"
          fi
          
          # Deploy infrastructure
          echo "ðŸš€ Deploying infrastructure..."
          az deployment group create \
            --name skillswap-infrastructure \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file azure-deploy/bicep/infrastructure.bicep \
            --parameters environmentName=${{ env.ENVIRONMENT }} \
            --parameters postgresPassword="$POSTGRES_PASSWORD" \
            --parameters jwtSecret="$JWT_SECRET"
          
          echo "âœ… Infrastructure deployed successfully"
          
          # Get non-sensitive outputs from deployment
          REGISTRY_NAME=$(az deployment group show --resource-group ${{ env.RESOURCE_GROUP }} --name skillswap-infrastructure --query properties.outputs.containerRegistryName.value -o tsv)
          REGISTRY_LOGIN_SERVER=$(az deployment group show --resource-group ${{ env.RESOURCE_GROUP }} --name skillswap-infrastructure --query properties.outputs.containerRegistryLoginServer.value -o tsv)
          CONTAINER_ENV_ID=$(az deployment group show --resource-group ${{ env.RESOURCE_GROUP }} --name skillswap-infrastructure --query properties.outputs.containerAppEnvironmentId.value -o tsv)
          POSTGRES_SERVER=$(az deployment group show --resource-group ${{ env.RESOURCE_GROUP }} --name skillswap-infrastructure --query properties.outputs.postgresServerName.value -o tsv)
          REDIS_HOSTNAME=$(az deployment group show --resource-group ${{ env.RESOURCE_GROUP }} --name skillswap-infrastructure --query properties.outputs.redisHostName.value -o tsv)
          SERVICEBUS_NAMESPACE=$(az deployment group show --resource-group ${{ env.RESOURCE_GROUP }} --name skillswap-infrastructure --query properties.outputs.serviceBusNamespaceName.value -o tsv)
          
          # Get sensitive data directly from Azure resources
          echo "ðŸ“¦ Fetching credentials..."
          ACR_CREDENTIALS=$(az acr credential show --name "$REGISTRY_NAME" --resource-group ${{ env.RESOURCE_GROUP }} -o json)
          REGISTRY_USERNAME=$(echo "$ACR_CREDENTIALS" | jq -r '.username')
          REGISTRY_PASSWORD=$(echo "$ACR_CREDENTIALS" | jq -r '.passwords[0].value')
          
          # Build connection strings
          POSTGRES_CONNECTION="Host=${POSTGRES_SERVER};Database=skillswap_users;Username=skillswapadmin;Password=${POSTGRES_PASSWORD}"
          
          # Get Redis key
          REDIS_KEY=$(az redis list-keys --name "${REDIS_HOSTNAME%%.*}" --resource-group ${{ env.RESOURCE_GROUP }} --query primaryKey -o tsv)
          REDIS_CONNECTION="${REDIS_HOSTNAME}:6379,password=${REDIS_KEY},ssl=True,abortConnect=False"
          
          # Get Service Bus connection string
          SERVICEBUS_CONNECTION=$(az servicebus namespace authorization-rule keys list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --namespace-name "$SERVICEBUS_NAMESPACE" \
            --name RootManageSharedAccessKey \
            --query primaryConnectionString -o tsv)
          
          # Write outputs to GITHUB_OUTPUT
          echo "registry_name=$REGISTRY_NAME" >> $GITHUB_OUTPUT
          echo "registry_login_server=$REGISTRY_LOGIN_SERVER" >> $GITHUB_OUTPUT
          echo "registry_username=$REGISTRY_USERNAME" >> $GITHUB_OUTPUT
          echo "registry_password=$REGISTRY_PASSWORD" >> $GITHUB_OUTPUT
          echo "postgres_connection=$POSTGRES_CONNECTION" >> $GITHUB_OUTPUT
          echo "redis_connection=$REDIS_CONNECTION" >> $GITHUB_OUTPUT
          echo "servicebus_connection=$SERVICEBUS_CONNECTION" >> $GITHUB_OUTPUT
          echo "container_env_id=$CONTAINER_ENV_ID" >> $GITHUB_OUTPUT
          echo "jwt_secret=$JWT_SECRET" >> $GITHUB_OUTPUT

  # Phase 2: Build and Push Docker Images
  build-images:
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Increase timeout for builds
    strategy:
      max-parallel: 2  # Limit to 2 parallel builds to avoid timeouts
      matrix:
        service:
          - name: gateway
            dockerfile: src/services/Gateway/Dockerfile
          - name: userservice
            dockerfile: src/services/UserService/UserService.Api/Dockerfile
          - name: skillservice
            dockerfile: src/services/SkillService/Dockerfile
          - name: matchmakingservice
            dockerfile: src/services/MatchmakingService/Dockerfile
          - name: appointmentservice
            dockerfile: src/services/AppointmentService/Dockerfile
          - name: notificationservice
            dockerfile: src/services/NotificationService/Dockerfile
          - name: videocallservice
            dockerfile: src/services/VideocallService/Dockerfile
          - name: frontend
            dockerfile: src/client/Dockerfile
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Build and push ${{ matrix.service.name }}
        run: |
          echo "ðŸ”¨ Building ${{ matrix.service.name }}..."
          
          # Special handling for frontend to set correct API URL
          if [ "${{ matrix.service.name }}" = "frontend" ]; then
            # Get the gateway URL for the frontend
            GATEWAY_URL="https://gateway.victoriousocean-546beaa5.westeurope.azurecontainerapps.io"
            
            # Build with correct API URL
            az acr build \
              --registry ${{ needs.deploy-infrastructure.outputs.registry_name }} \
              --image ${{ matrix.service.name }}:${{ github.sha }} \
              --image ${{ matrix.service.name }}:latest \
              --file ${{ matrix.service.dockerfile }} \
              --build-arg VITE_API_BASE_URL="${GATEWAY_URL}" \
              src/
          else
            # Regular build for other services
            az acr build \
              --registry ${{ needs.deploy-infrastructure.outputs.registry_name }} \
              --image ${{ matrix.service.name }}:${{ github.sha }} \
              --image ${{ matrix.service.name }}:latest \
              --file ${{ matrix.service.dockerfile }} \
              src/
          fi
          
          echo "âœ… ${{ matrix.service.name }} built and pushed"

  # Phase 3: Deploy Container Apps
  deploy-apps:
    needs: [deploy-infrastructure, build-images]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy Container Apps
        run: |
          echo "ðŸš€ Fetching deployment credentials from Azure..."
          
          # Get Container Registry credentials
          REGISTRY_NAME="skillswapstagingacr"
          ACR_CREDENTIALS=$(az acr credential show --name "$REGISTRY_NAME" --resource-group ${{ env.RESOURCE_GROUP }} -o json)
          REGISTRY_USERNAME=$(echo "$ACR_CREDENTIALS" | jq -r '.username')
          REGISTRY_PASSWORD=$(echo "$ACR_CREDENTIALS" | jq -r '.passwords[0].value')
          
          # Get Container App Environment ID
          CONTAINER_ENV_ID=$(az containerapp env show --name "skillswap-staging-env" --resource-group ${{ env.RESOURCE_GROUP }} --query id -o tsv)
          
          # Build connection strings
          POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
          if [ -z "$POSTGRES_PASSWORD" ]; then
            POSTGRES_PASSWORD="SkillSwap2024SecurePassword!"
          fi
          POSTGRES_CONNECTION="Host=skillswap-staging-postgres.postgres.database.azure.com;Database=skillswap_users;Username=skillswapadmin;Password=${POSTGRES_PASSWORD}"
          
          # Get Redis connection
          REDIS_KEY=$(az redis list-keys --name "skillswapstagingredis" --resource-group ${{ env.RESOURCE_GROUP }} --query primaryKey -o tsv)
          REDIS_CONNECTION="skillswapstagingredis.redis.cache.windows.net:6379,password=${REDIS_KEY},ssl=True,abortConnect=False"
          
          # Get Service Bus connection
          SERVICEBUS_CONNECTION=$(az servicebus namespace authorization-rule keys list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --namespace-name "skillswap-staging-bus" \
            --name RootManageSharedAccessKey \
            --query primaryConnectionString -o tsv)
          
          # Get JWT Secret
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          if [ -z "$JWT_SECRET" ]; then
            JWT_SECRET="your-super-secure-jwt-secret-key-that-is-at-least-32-characters"
          fi
          
          # Get Superadmin Password
          SUPERADMIN_PASSWORD="${{ secrets.SUPERADMIN_PASSWORD }}"
          if [ -z "$SUPERADMIN_PASSWORD" ]; then
            SUPERADMIN_PASSWORD="Admin123!@#"
          fi
          
          echo "ðŸš€ Deploying Container Apps..."
          
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file azure-deploy/bicep/container-apps.bicep \
            --parameters containerRegistryLoginServer="${REGISTRY_NAME}.azurecr.io" \
            --parameters containerRegistryName="$REGISTRY_NAME" \
            --parameters containerRegistryUsername="$REGISTRY_USERNAME" \
            --parameters containerRegistryPassword="$REGISTRY_PASSWORD" \
            --parameters containerAppEnvironmentId="$CONTAINER_ENV_ID" \
            --parameters postgresConnectionString="$POSTGRES_CONNECTION" \
            --parameters redisConnectionString="$REDIS_CONNECTION" \
            --parameters serviceBusConnectionString="$SERVICEBUS_CONNECTION" \
            --parameters jwtSecret="$JWT_SECRET" \
            --parameters superadminPassword="$SUPERADMIN_PASSWORD" \
            --parameters imageTag="${{ github.sha }}" \
            --output none
          
          echo "âœ… Container Apps deployed"
      
      - name: Get Application URLs
        run: |
          echo "# ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          GATEWAY_URL=$(az containerapp show \
            --name gateway \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          
          FRONTEND_URL=$(az containerapp show \
            --name frontend \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          
          echo "## ðŸŒ Application URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** https://$FRONTEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **API Gateway:** https://$GATEWAY_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Deployment Info:" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group:** ${{ env.RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY