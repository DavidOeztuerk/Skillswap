name: Backmerge main â†’ develop

# Automatically creates a PR to merge main back into develop after every production deployment
# This ensures hotfixes and release changes are always synced back to develop

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  backmerge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for differences
        id: diff-check
        run: |
          git fetch origin develop
          DIFF_COUNT=$(git rev-list --count origin/develop..origin/main)
          echo "diff_count=$DIFF_COUNT" >> $GITHUB_OUTPUT
          if [ "$DIFF_COUNT" -eq "0" ]; then
            echo "No differences between main and develop"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Found $DIFF_COUNT commits to backmerge"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Check for existing backmerge PR
        id: check-pr
        if: steps.diff-check.outputs.has_changes == 'true'
        run: |
          EXISTING_PR=$(gh pr list --base develop --head main --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "Existing backmerge PR found: #$EXISTING_PR"
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            echo "No existing backmerge PR found"
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        id: create-pr
        if: steps.diff-check.outputs.has_changes == 'true' && steps.check-pr.outputs.pr_exists == 'false'
        run: |
          PR_URL=$(gh pr create \
            --base develop \
            --head main \
            --title "ðŸ”„ Backmerge: main â†’ develop" \
            --body "$(cat <<'EOF'
          ## Automatic Backmerge

          This PR was automatically created to sync changes from `main` back to `develop`.

          ### Why is this needed?
          - Production hotfixes need to be in develop
          - Release fixes must be synced back
          - `main` is the source of truth for production

          ### Changes included
          - All commits that were merged to `main` since last sync
          - Includes: hotfixes, release fixes, any direct main commits

          ### Action required
          - Review the changes
          - Resolve any merge conflicts if present
          - Merge this PR to keep `develop` in sync

          ---
          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          EOF
          )" \
            --label "backmerge" \
            --label "automated")

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Created PR: $PR_URL"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          if [ "${{ steps.diff-check.outputs.has_changes }}" == "true" ]; then
            if [ "${{ steps.check-pr.outputs.pr_exists }}" == "true" ]; then
              echo "## ðŸ”„ Backmerge PR Already Exists" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "PR #${{ steps.check-pr.outputs.pr_number }} is already open for backmerging \`main\` into \`develop\`." >> $GITHUB_STEP_SUMMARY
            else
              echo "## ðŸ”„ Backmerge PR Created" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "A pull request has been created to merge \`main\` into \`develop\`." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**PR URL:** ${{ steps.create-pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Please review and merge the PR to keep branches in sync.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Branches in Sync" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`main\` and \`develop\` are already in sync. No backmerge needed." >> $GITHUB_STEP_SUMMARY
          fi
